apiVersion: batch/v1
kind: Job
metadata:
  name: create-breakglass-user-master-realm
  namespace: keycloak
  annotations:
    argocd.argoproj.io/sync-wave: "15"
spec:
  backoffLimit: 2
  activeDeadlineSeconds: 120
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: kcadm
          image: quay.io/keycloak/keycloak:26.5
          command:
            - /bin/bash
            - -ec
            - |
              KEYCLOAK_SERVICE_NAME=keycloak-service
              KEYCLOAK_SERVICE_PORT=8080
              KEYCLOAK_URL=http://$KEYCLOAK_SERVICE_NAME:$KEYCLOAK_SERVICE_PORT

              echo "üîå Check Keycloak socket"
              SOCKET_OK=false
              for i in {1..12}; do
                if (echo > /dev/tcp/$KEYCLOAK_SERVICE_NAME/$KEYCLOAK_SERVICE_PORT) >/dev/null 2>&1; then
                  SOCKET_OK=true
                  break
                fi
                echo "üõë Socket not ready yet"
                sleep 5
              done
              [ "$SOCKET_OK" != "true" ] && echo "üõë ERROR: Keycloak service unreachable" && exit 1

              echo "üîê Authenticate to Keycloak"
              LOGIN_SUCCESS=false
              for i in {1..12}; do
                if /opt/keycloak/bin/kcadm.sh config credentials \
                  --realm master \
                  --server "$KEYCLOAK_URL" \
                  --user "$BOOTSTRAP_USER" \
                  --password "$BOOTSTRAP_PASSWORD"; then
                  LOGIN_SUCCESS=true
                  break
                fi
                echo "üõë Login not ready yet"
                sleep 5
              done
              [ "$LOGIN_SUCCESS" != "true" ] && echo "üõë ERROR: Keycloak not ready for authentication" && exit 1

              echo "üîé Resolve bootstrap user ID"
              BOOTSTRAP_USER_ID=$(/opt/keycloak/bin/kcadm.sh get users \
                -r master \
                -q username="$BOOTSTRAP_USER" \
                --fields id,username \
                --format csv --noquotes \
                | grep -E ",$BOOTSTRAP_USER$" \
                | head -n 1 \
                | cut -d',' -f1)

              echo "üîé Resolve breakglass user ID"
              BREAKGLASS_USER_ID=$(/opt/keycloak/bin/kcadm.sh get users \
                -r master \
                -q username="$BREAKGLASS_USER" \
                --fields id,username \
                --format csv --noquotes \
                | grep -E ",$BREAKGLASS_USER$" \
                | head -n 1 \
                | cut -d',' -f1)

              if [ -z "$BREAKGLASS_USER_ID" ]; then
                echo "üë§ Create breakglass user"

                /opt/keycloak/bin/kcadm.sh create users \
                  -r master \
                  -s username="$BREAKGLASS_USER" \
                  -s firstName="$BREAKGLASS_FIRSTNAME" \
                  -s lastName="$BREAKGLASS_LASTNAME" \
                  -s email="$BREAKGLASS_EMAIL" \
                  -s emailVerified=true \
                  -s enabled=true

                sleep 5

                BREAKGLASS_USER_ID=$(/opt/keycloak/bin/kcadm.sh get users \
                  -r master \
                  -q username="$BREAKGLASS_USER" \
                  --fields id,username \
                  --format csv --noquotes \
                  | grep -E ",$BREAKGLASS_USER$" \
                  | head -n 1 \
                  | cut -d',' -f1)
              else
                echo "ü§∑ Breakglass user already exists"
              fi

              [ -z "$BREAKGLASS_USER" ] && echo "üõë ERROR: Could not resolve breakglass BREAKGLASS_USER" && exit 1

              echo "üîë Set permanent password"
              /opt/keycloak/bin/kcadm.sh set-password \
                -r master \
                --userid "$BREAKGLASS_USER_ID" \
                --new-password "$BREAKGLASS_PASSWORD"

              echo "üõ°Ô∏è Grant admin role to breakglass user"
              /opt/keycloak/bin/kcadm.sh add-roles \
                -r master \
                --uid "$BREAKGLASS_USER_ID" \
                --rolename admin || true
              
              echo "‚ùå Delete bootstrap user"
              /opt/keycloak/bin/kcadm.sh delete users/$BOOTSTRAP_USER_ID -r master

              echo "üü¢ Breakglass user ready"

          env:
            - name: BOOTSTRAP_USER
              value: admin
            - name: BOOTSTRAP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-bootstrap
                  key: password
            - name: BREAKGLASS_USER
              valueFrom:
                secretKeyRef:
                  name: keycloak-breakglass
                  key: username
            - name: BREAKGLASS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-breakglass
                  key: password
            - name: BREAKGLASS_EMAIL
              value: r.karamad@gmail.com
            - name: BREAKGLASS_FIRSTNAME
              value: Keycloak
            - name: BREAKGLASS_LASTNAME
              value: Administrator

---
