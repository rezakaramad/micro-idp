apiVersion: batch/v1
kind: Job
metadata:
  name: create-breakglass-user-master-realm
  namespace: keycloak
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  backoffLimit: 2
  activeDeadlineSeconds: 120
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: kcadm
          image: quay.io/keycloak/keycloak:26.5
          command:
            - /bin/bash
            - -ec
            - |
              KC=http://keycloak-service:8080

              echo "Checking Keycloak socket..."
              SOCKET_OK=false
              for i in {1..12}; do
                if (echo > /dev/tcp/keycloak-service/8080) >/dev/null 2>&1; then
                  SOCKET_OK=true
                  break
                fi
                echo "Socket not ready yet..."
                sleep 5
              done
              [ "$SOCKET_OK" != "true" ] && echo "ERROR: Keycloak service unreachable" && exit 1

              echo "Checking Keycloak authentication..."
              LOGIN_SUCCESS=false
              for i in {1..12}; do
                if /opt/keycloak/bin/kcadm.sh config credentials \
                  --server "$KC" --realm master \
                  --user "$BOOTSTRAP_USER" --password "$BOOTSTRAP_PASSWORD"; then
                  LOGIN_SUCCESS=true
                  break
                fi
                echo "Login not ready yet..."
                sleep 5
              done
              [ "$LOGIN_SUCCESS" != "true" ] && echo "ERROR: Keycloak not ready for authentication" && exit 1

              echo "Ensuring breakglass user exists"
              USER_ID=$(/opt/keycloak/bin/kcadm.sh get users -r master \
                -q username="$BREAKGLASS_USER" --fields id --format csv \
                | tail -n +2 | head -n 1 | tr -d '"')

              if [ -z "$USER_ID" ]; then
                echo "Creating breakglass user"
                /opt/keycloak/bin/kcadm.sh create users -r master \
                  -s username="$BREAKGLASS_USER" \
                  -s enabled=true

                USER_ID=$(echo "$CREATE_OUTPUT" | grep -oE "[0-9a-fA-F-]{36}")
              fi

              [ -z "$USER_ID" ] && echo "ERROR: Could not resolve breakglass USER_ID" && exit 1

              echo "Setting permanent password (creates credential in KC26+)"
              /opt/keycloak/bin/kcadm.sh update "users/$USER_ID/reset-password" -r master \
                -s type=password \
                -s value="$BREAKGLASS_PASSWORD" \
                -s temporary=false

              echo "Ensuring admin role"
              /opt/keycloak/bin/kcadm.sh add-roles -r master --uid "$USER_ID" --rolename admin || true

              echo "Breakglass user ready"

          env:
            - name: BOOTSTRAP_USER
              value: admin
            - name: BOOTSTRAP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-bootstrap
                  key: password
            - name: BREAKGLASS_USER
              valueFrom:
                secretKeyRef:
                  name: keycloak-breakglass
                  key: username
            - name: BREAKGLASS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-breakglass
                  key: password

# ---
# apiVersion: batch/v1
# kind: Job
# metadata:
#   name: enable-oidc-master-realm
#   namespace: keycloak
#   annotations:
#     "helm.sh/hook": post-install,post-upgrade
#     "helm.sh/hook-weight": "0"
#     "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
# spec:
#   backoffLimit: 0
#   template:
#     spec:
#       restartPolicy: Never
#       containers:
#         - name: configure-oidc
#           image: quay.io/keycloak/keycloak:26.5
#           command:
#             - /bin/bash
#             - -ec
#             - |
#               KC=http://keycloak-service:8080

#               echo "Checking Keycloak socket..."
#               for i in {1..3}; do
#                 (echo > /dev/tcp/keycloak-service/8080) >/dev/null 2>&1 && break
#                 echo "Socket not ready yet..."
#                 sleep 5
#               done

#               echo "Checking Keycloak authentication..."
#               LOGIN_SUCCESS=false
#               for i in {1..3}; do
#                 if /opt/keycloak/bin/kcadm.sh config credentials \
#                   --server $KC --realm master \
#                   --user "$BOOTSTRAP_USER" --password "$BOOTSTRAP_PASSWORD"; then
#                   LOGIN_SUCCESS=true
#                   break
#                 fi
#                 sleep 5
#               done
#               [ "$LOGIN_SUCCESS" != "true" ] && echo "ERROR: Keycloak not ready" && exit 1


#               echo "Ensuring breakglass user exists"
#               USER_ID=$(/opt/keycloak/bin/kcadm.sh get users -r master \
#                 -q username="$BREAKGLASS_USER" --fields id --format csv \
#                 | tail -n1 | tr -d '"')

#               if [ -z "$USER_ID" ]; then
#                 echo "Creating breakglass user"
#                 /opt/keycloak/bin/kcadm.sh create users -r master \
#                   -s username="$BREAKGLASS_USER" \
#                   -s enabled=true

#                 USER_ID=$(/opt/keycloak/bin/kcadm.sh get users -r master \
#                   -q username="$BREAKGLASS_USER" --fields id --format csv \
#                   | tail -n1 | tr -d '"')
#               fi


#               echo "Setting permanent password"
#               /opt/keycloak/bin/kcadm.sh update users/$USER_ID/reset-password -r master \
#                 -s type=password \
#                 -s value="$BREAKGLASS_PASSWORD" \
#                 -s temporary=false


#               echo "Granting admin role"
#               /opt/keycloak/bin/kcadm.sh add-roles -r master --uid "$USER_ID" --rolename admin || true

#               echo "Breakglass user ready"
#           env:
#             - name: BREAKGLASS_USER
#               valueFrom:
#                 secretKeyRef:
#                   name: keycloak-breakglass
#                   key: username
#             - name: BREAKGLASS_PASSWORD
#               valueFrom:
#                 secretKeyRef:
#                   name: keycloak-breakglass
#                   key: password
#             - name: TENANT_ID
#               value: c6ba6fd6-0fdd-4458-ad98-0c292dd79188
#             - name: CLIENT_ID
#               value: c25f407d-7794-4e55-bd0a-f0cd20bc6de2
#             - name: CLIENT_SECRET
#               valueFrom:
#                 secretKeyRef:
#                   name: azure-oidc-master
#                   key: client-secret
#             - name: PLATFORM_ADMINS_GROUP_ID
#               value: 9b207afe-3824-482f-8985-e2337a7f7e9b

# ---
# apiVersion: batch/v1
# kind: Job
# metadata:
#   name: delete-bootstrap-user-master-realm
#   namespace: keycloak
#   annotations:
#     "helm.sh/hook": post-install,post-upgrade
#     "helm.sh/hook-weight": "10"
#     "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
# spec:
#   backoffLimit: 0
#   activeDeadlineSeconds: 120
#   template:
#     spec:
#       restartPolicy: Never
#       containers:
#         - name: cleanup
#           image: quay.io/keycloak/keycloak:26.5
#           command:
#             - /bin/bash
#             - -ec
#             - |
#               KC=http://keycloak-service:8080

#               echo "Checking Keycloak socket..."
#               SOCKET_OK=false
#               for i in {1..3}; do
#                 if (echo > /dev/tcp/keycloak-service/8080) >/dev/null 2>&1; then
#                   SOCKET_OK=true
#                   break
#                 fi
#                 echo "Socket not ready yet..."
#                 sleep 5
#               done
#               [ "$SOCKET_OK" != "true" ] && echo "ERROR: Keycloak service unreachable" && exit 1

#               echo "Checking Keycloak authentication..."
#               LOGIN_SUCCESS=false
#               for i in {1..3}; do
#                 if /opt/keycloak/bin/kcadm.sh config credentials \
#                   --server $KC --realm master \
#                   --user "$BREAKGLASS_USER" --password "$BREAKGLASS_PASSWORD"; then
#                   LOGIN_SUCCESS=true
#                   break
#                 fi
#                 echo "Login not ready yet..."
#                 sleep 5
#               done
#               [ "$LOGIN_SUCCESS" != "true" ] && echo "ERROR: Cannot login to Keycloak" && exit 1

#               BG_ID=$(/opt/keycloak/bin/kcadm.sh get users -r master -q username="$BREAKGLASS_USER" --fields id --format csv | tail -n1)
#               ROLE_CHECK=$(/opt/keycloak/bin/kcadm.sh get users/$BG_ID/role-mappings/realm -r master | grep '"name" : "admin"' || true)
#               [ -z "$ROLE_CHECK" ] && echo "Breakglass not admin — abort" && exit 1

#               if ! /opt/keycloak/bin/kcadm.sh get identity-provider/instances/azure -r master >/dev/null 2>&1; then
#                 echo "IdP missing — abort"
#                 exit 1
#               fi

#               OLD_ID=$(/opt/keycloak/bin/kcadm.sh get users -r master -q username="$BOOTSTRAP_USER" --fields id --format csv | tail -n1)
#               [ -z "$OLD_ID" ] && exit 0

#               /opt/keycloak/bin/kcadm.sh delete users/$OLD_ID -r master
#           env:
#             - name: BOOTSTRAP_USER
#               value: admin
#             - name: BREAKGLASS_USER
#               valueFrom:
#                 secretKeyRef:
#                   name: keycloak-breakglass
#                   key: username
#             - name: BREAKGLASS_PASSWORD
#               valueFrom:
#                 secretKeyRef:
#                   name: keycloak-breakglass
#                   key: password

# ---
