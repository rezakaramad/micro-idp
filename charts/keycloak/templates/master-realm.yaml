apiVersion: batch/v1
kind: Job
metadata:
  name: create-breakglass-user-master-realm
  namespace: keycloak
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  backoffLimit: 2
  activeDeadlineSeconds: 120
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: kcadm
          image: quay.io/keycloak/keycloak:26.5
          command:
            - /bin/bash
            - -ec
            - |
              KEYCLOAK_SERVICE_NAME=keycloak-service
              KEYCLOAK_SERVICE_PORT=8080
              KEYCLOAK_URL=http://$KEYCLOAK_SERVICE_NAME:$KEYCLOAK_SERVICE_PORT

              echo "üîå Check Keycloak socket"
              SOCKET_OK=false
              for i in {1..12}; do
                if (echo > /dev/tcp/$KEYCLOAK_SERVICE_NAME/$KEYCLOAK_SERVICE_PORT) >/dev/null 2>&1; then
                  SOCKET_OK=true
                  break
                fi
                echo "üõë Socket not ready yet"
                sleep 5
              done
              [ "$SOCKET_OK" != "true" ] && echo "üõë ERROR: Keycloak service unreachable" && exit 1

              echo "üîê Authenticate to Keycloak"
              LOGIN_SUCCESS=false
              for i in {1..12}; do
                if /opt/keycloak/bin/kcadm.sh config credentials \
                  --realm master \
                  --server "$KEYCLOAK_URL" \
                  --user "$BOOTSTRAP_USER" \
                  --password "$BOOTSTRAP_PASSWORD"; then
                  LOGIN_SUCCESS=true
                  break
                fi
                echo "üõë Login not ready yet"
                sleep 5
              done
              [ "$LOGIN_SUCCESS" != "true" ] && echo "üõë ERROR: Keycloak not ready for authentication" && exit 1

              echo "üë§ Check breakglass user exists"

              USER_ID=$(/opt/keycloak/bin/kcadm.sh get users \
                -r master \
                -q username="$BREAKGLASS_USER" \
                --fields id \
                --format csv --noquotes)

              if [ -z "$USER_ID" ]; then
                echo "üë§ Create breakglass user"

                /opt/keycloak/bin/kcadm.sh create users \
                  -r master \
                  -s username="$BREAKGLASS_USER" \
                  -s firstName="$BREAKGLASS_FIRSTNAME" \
                  -s lastName="$BREAKGLASS_LASTNAME" \
                  -s email="$BREAKGLASS_EMAIL" \
                  -s emailVerified=true \
                  -s enabled=true

                sleep 5

                USER_ID=$(/opt/keycloak/bin/kcadm.sh get users \
                  -r master \
                  -q username="$BREAKGLASS_USER" \
                  --fields id \
                  --format csv --noquotes)
              else
                echo "üë§ Breakglass user already exists"
              fi

              [ -z "$USER_ID" ] && echo "üõë ERROR: Could not resolve breakglass USER_ID" && exit 1

              echo "üîë Set permanent password"
              
              /opt/keycloak/bin/kcadm.sh set-password \
                -r master \
                --userid "$USER_ID" \
                --new-password "$BREAKGLASS_PASSWORD"

              echo "üõ°Ô∏è Grant admin role"
              /opt/keycloak/bin/kcadm.sh add-roles \
                -r master \
                --uid "$USER_ID" \
                --rolename admin || true

              echo "üü¢ Breakglass user ready"

          env:
            - name: BOOTSTRAP_USER
              value: admin
            - name: BOOTSTRAP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-bootstrap
                  key: password
            - name: BREAKGLASS_USER
              valueFrom:
                secretKeyRef:
                  name: keycloak-breakglass
                  key: username
            - name: BREAKGLASS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-breakglass
                  key: password
            - name: BREAKGLASS_EMAIL
              value: r.karamad@gmail.com
            - name: BREAKGLASS_FIRSTNAME
              value: Keycloak
            - name: BREAKGLASS_LASTNAME
              value: Administrator

---
apiVersion: batch/v1
kind: Job
metadata:
  name: enable-oidc-master-realm
  namespace: keycloak
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: configure-oidc
          image: quay.io/keycloak/keycloak:26.5
          command:
            - /bin/bash
            - -ec
            - |
              KEYCLOAK_SERVICE_NAME=keycloak-service
              KEYCLOAK_SERVICE_PORT=8080
              KEYCLOAK_URL=http://$KEYCLOAK_SERVICE_NAME:$KEYCLOAK_SERVICE_PORT

              echo "üîå Check Keycloak socket"
              SOCKET_OK=false
              for i in {1..12}; do
                if (echo > /dev/tcp/$KEYCLOAK_SERVICE_NAME/$KEYCLOAK_SERVICE_PORT) >/dev/null 2>&1; then
                  SOCKET_OK=true
                  break
                fi
                echo "üõë Socket not ready yet"
                sleep 5
              done
              [ "$SOCKET_OK" != "true" ] && echo "üõë ERROR: Keycloak service unreachable" && exit 1

              echo "üîê Authenticate to Keycloak"
              LOGIN_SUCCESS=false
              for i in {1..12}; do
                if /opt/keycloak/bin/kcadm.sh config credentials \
                  --realm master \
                  --server "$KEYCLOAK_URL" \
                  --user "$BREAKGLASS_USER" \
                  --password "$BREAKGLASS_PASSWORD"; then
                  LOGIN_SUCCESS=true
                  break
                fi
                echo "üõë Login not ready yet"
                sleep 5
              done
              [ "$LOGIN_SUCCESS" != "true" ] && echo "üõë ERROR: Keycloak not ready for authentication" && exit 1

              echo "‚òÅÔ∏è Create/update Azure IdP"
              IDP_CONFIG=(
                -s enabled=true
                -s displayName="Azure AD"
                -s trustEmail=true
                -s "config.authorizationUrl=https://login.microsoftonline.com/$TENANT_ID/oauth2/v2.0/authorize"
                -s "config.tokenUrl=https://login.microsoftonline.com/$TENANT_ID/oauth2/v2.0/token"
                -s "config.jwksUrl=https://login.microsoftonline.com/$TENANT_ID/discovery/v2.0/keys"
                -s "config.logoutUrl=https://login.microsoftonline.com/$TENANT_ID/oauth2/v2.0/logout"
                -s "config.userInfoUrl=https://graph.microsoft.com/oidc/userinfo"
                -s "config.issuer=https://login.microsoftonline.com/$TENANT_ID/v2.0"
                -s "config.defaultScope=openid profile email"
                -s "config.clientId=$CLIENT_ID"
                -s "config.clientSecret=$CLIENT_SECRET"
              )

              echo "üîÅ Reconcile Azure IdP"

              if /opt/keycloak/bin/kcadm.sh get identity-provider/instances/azure -r master >/dev/null 2>&1; then
                echo "üí° Azure IdP exists - updating ..."
                /opt/keycloak/bin/kcadm.sh update identity-provider/instances/azure \
                  -r master \
                  "${IDP_CONFIG[@]}"
              else
                echo "üí° Azure IdP does not exist - creating ..."
                /opt/keycloak/bin/kcadm.sh create identity-provider/instances \
                  -r master \
                  -s alias=azure \
                  -s providerId=oidc \
                  "${IDP_CONFIG[@]}"
              fi

              echo "üë• Ensure '$PLATFORM_ADMINS_GROUP_NAME' group exists (create if missing)"
              /opt/keycloak/bin/kcadm.sh create groups \
                -r master \
                -s name=$PLATFORM_ADMINS_GROUP_NAME >/dev/null 2>&1 || true

              echo "üë• Resolve '$PLATFORM_ADMINS_GROUP_NAME' ID"
              GROUP_ID=$(/opt/keycloak/bin/kcadm.sh get groups \
                -r master \
                -q name='$PLATFORM_ADMINS_GROUP_NAME' \
                --fields id \
                --format csv --noquotes)

              [ -z "$GROUP_ID" ] && echo "üõë ERROR: $PLATFORM_ADMINS_GROUP_NAME group not found" && exit 1

              echo "üõ°Ô∏è Assign 'admin' role to '$PLATFORM_ADMINS_GROUP_NAME'"
              /opt/keycloak/bin/kcadm.sh add-roles \
                -r master \
                --gid "$GROUP_ID" \
                --rolename admin || true

              
              cat <<EOF > /tmp/platform-admins-mapper.json
              {
                "name": "$PLATFORM_ADMINS_GROUP_NAME",
                "identityProviderAlias": "azure",
                "identityProviderMapper": "oidc-advanced-group-idp-mapper",
                "config": {
                  "claim": "groups",
                  "claim.value": "$PLATFORM_ADMINS_GROUP_ID",
                  "group": "/$PLATFORM_ADMINS_GROUP_NAME",
                  "syncMode": "INHERIT"
                }
              }
              EOF

              /opt/keycloak/bin/kcadm.sh create identity-provider/instances/azure/mappers \
                -r master \
                -f /tmp/platform-admins-mapper.json

              echo "üü¢ OIDC successfully configured"
          env:
            - name: BREAKGLASS_USER
              valueFrom:
                secretKeyRef:
                  name: keycloak-breakglass
                  key: username
            - name: BREAKGLASS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-breakglass
                  key: password
            - name: TENANT_ID
              value: c6ba6fd6-0fdd-4458-ad98-0c292dd79188
            - name: CLIENT_ID
              value: 3bb8c767-9c1f-4ce2-823e-39e8fa6b907c
            - name: CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: azure-oidc-master
                  key: client-secret
            - name: PLATFORM_ADMINS_GROUP_ID
              value: 9b207afe-3824-482f-8985-e2337a7f7e9b
            - name: PLATFORM_ADMINS_GROUP_NAME
              value: platform-admins

---
apiVersion: batch/v1
kind: Job
metadata:
  name: delete-bootstrap-user-master-realm
  namespace: keycloak
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  backoffLimit: 0
  activeDeadlineSeconds: 120
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: cleanup
          image: quay.io/keycloak/keycloak:26.5
          command:
            - /bin/bash
            - -ec
            - |
              KEYCLOAK_SERVICE_NAME=keycloak-service
              KEYCLOAK_SERVICE_PORT=8080
              KEYCLOAK_URL=http://$KEYCLOAK_SERVICE_NAME:$KEYCLOAK_SERVICE_PORT

              echo "üîå Check Keycloak socket..."
              SOCKET_OK=false
              for i in {1..12}; do
                if (echo > /dev/tcp/$KEYCLOAK_SERVICE_NAME/$KEYCLOAK_SERVICE_PORT) >/dev/null 2>&1; then
                  SOCKET_OK=true
                  break
                fi
                echo "üõë Socket not ready yet..."
                sleep 5
              done
              [ "$SOCKET_OK" != "true" ] && echo "üõë ERROR: Keycloak service unreachable" && exit 1

              echo "üîê Authenticate to Keycloak"
              LOGIN_SUCCESS=false
              for i in {1..12}; do
                if /opt/keycloak/bin/kcadm.sh config credentials \
                  --realm master \
                  --server "$KEYCLOAK_URL" \
                  --user "$BREAKGLASS_USER" \
                  --password "$BREAKGLASS_PASSWORD"; then
                  LOGIN_SUCCESS=true
                  break
                fi
                echo "üõë Login not ready yet..."
                sleep 5
              done
              [ "$LOGIN_SUCCESS" != "true" ] && echo "üõë ERROR: Keycloak not ready for authentication" && exit 1

              echo "üë§ Ensure bootstrap user exists"
              USER_ID=$(/opt/keycloak/bin/kcadm.sh get users \
                -r master \
                -q username="$BOOTSTRAP_USER" \
                --fields id \
                --format csv --noquotes)

              [ -z "$USER_ID" ] && echo "üõë ERROR: Could not resolve bootstrap uesr" && exit 1

              echo "üë§ Delete bootstrap user"
              /opt/keycloak/bin/kcadm.sh delete users/$USER_ID -r master
          env:
            - name: BOOTSTRAP_USER
              value: admin
            - name: BREAKGLASS_USER
              valueFrom:
                secretKeyRef:
                  name: keycloak-breakglass
                  key: username
            - name: BREAKGLASS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-breakglass
                  key: password

---
