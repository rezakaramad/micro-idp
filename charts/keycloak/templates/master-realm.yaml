apiVersion: batch/v1
kind: Job
metadata:
  name: create-breakglass-user-master-realm
  namespace: keycloak
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  backoffLimit: 6
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: kcadm
          image: quay.io/keycloak/keycloak:26.5
          command:
            - /bin/bash
            - -ec
            - |
              KC=http://keycloak-service:8080

              echo "Checking Keycloak socket..."
              SOCKET_OK=false
              for i in {1..3}; do
                if (echo > /dev/tcp/keycloak-service/8080) >/dev/null 2>&1; then
                  SOCKET_OK=true
                  break
                fi
                echo "Socket not ready yet..."
                sleep 5
              done
              [ "$SOCKET_OK" != "true" ] && echo "ERROR: Keycloak service unreachable" && exit 1

              echo "Checking Keycloak authentication..."
              LOGIN_SUCCESS=false
              for i in {1..3}; do
                if /opt/keycloak/bin/kcadm.sh config credentials \
                  --server $KC --realm master \
                  --user "$BOOTSTRAP_USER" --password "$BOOTSTRAP_PASSWORD"; then
                  LOGIN_SUCCESS=true
                  break
                fi
                echo "Login not ready yet..."
                sleep 5
              done
              [ "$LOGIN_SUCCESS" != "true" ] && echo "ERROR: Keycloak not ready for authentication" && exit 1

              echo "Ensuring breakglass user exists"
              USER_ID=$(/opt/keycloak/bin/kcadm.sh get users -r master -q username="$BREAKGLASS_USER" --fields id --format csv | tail -n1)

              if [ -z "$USER_ID" ]; then
                echo "Creating breakglass user"
                /opt/keycloak/bin/kcadm.sh create users -r master -s username="$BREAKGLASS_USER" -s enabled=true
                USER_ID=$(/opt/keycloak/bin/kcadm.sh get users -r master -q username="$BREAKGLASS_USER" --fields id --format csv | tail -n1)

                /opt/keycloak/bin/kcadm.sh set-password -r master \
                  --userid "$USER_ID" \
                  --new-password "$BREAKGLASS_PASSWORD" \
                  --temporary=false
              fi

              echo "Ensuring admin role"
              /opt/keycloak/bin/kcadm.sh add-roles -r master --uid "$USER_ID" --rolename admin || true
          env:
            - name: BOOTSTRAP_USER
              value: admin
            - name: BOOTSTRAP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-bootstrap
                  key: password
            - name: BREAKGLASS_USER
              valueFrom:
                secretKeyRef:
                  name: keycloak-breakglass
                  key: username
            - name: BREAKGLASS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-breakglass
                  key: password

---
apiVersion: batch/v1
kind: Job
metadata:
  name: enable-oidc-master-realm
  namespace: keycloak
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  backoffLimit: 6
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: configure-oidc
          image: quay.io/keycloak/keycloak:26.5
          command:
            - /bin/bash
            - -ec
            - |
              KC=http://keycloak-service:8080

              echo "Checking Keycloak socket..."
              SOCKET_OK=false
              for i in {1..3}; do
                if (echo > /dev/tcp/keycloak-service/8080) >/dev/null 2>&1; then
                  SOCKET_OK=true
                  break
                fi
                echo "Socket not ready yet..."
                sleep 5
              done
              [ "$SOCKET_OK" != "true" ] && echo "ERROR: Keycloak service unreachable" && exit 1

              echo "Checking Keycloak authentication..."
              LOGIN_SUCCESS=false
              for i in {1..3}; do
                if /opt/keycloak/bin/kcadm.sh config credentials \
                  --server $KC --realm master \
                  --user "$BOOTSTRAP_USER" --password "$BOOTSTRAP_PASSWORD"; then
                  LOGIN_SUCCESS=true
                  break
                fi
                echo "Login not ready yet..."
                sleep 5
              done
              [ "$LOGIN_SUCCESS" != "true" ] && echo "ERROR: Cannot login to Keycloak" && exit 1

              if /opt/keycloak/bin/kcadm.sh get identity-provider/instances/azure -r master >/dev/null 2>&1; then
                /opt/keycloak/bin/kcadm.sh update identity-provider/instances/azure -r master \
                  -s enabled=true \
                  -s displayName="Azure AD" \
                  -s trustEmail=true \
                  -s 'config.clientId='"$CLIENT_ID" \
                  -s 'config.clientSecret='"$CLIENT_SECRET"
              else
                /opt/keycloak/bin/kcadm.sh create identity-provider/instances -r master \
                  -s alias=azure -s providerId=oidc -s enabled=true \
                  -s displayName="Azure AD" -s trustEmail=true \
                  -s 'config.authorizationUrl=https://login.microsoftonline.com/'"$TENANT_ID"'/oauth2/v2.0/authorize' \
                  -s 'config.tokenUrl
          env:
            - name: BOOTSTRAP_USER
              value: admin
            - name: BREAKGLASS_USER
              valueFrom:
                secretKeyRef:
                  name: keycloak-breakglass
                  key: username
            - name: BREAKGLASS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-breakglass
                  key: password

---
apiVersion: batch/v1
kind: Job
metadata:
  name: delete-bootstrap-user-master-realm
  namespace: keycloak
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  backoffLimit: 6
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: cleanup
          image: quay.io/keycloak/keycloak:26.5
          command:
            - /bin/bash
            - -ec
            - |
              KC=http://keycloak-service:8080

              echo "Checking Keycloak socket..."
              SOCKET_OK=false
              for i in {1..3}; do
                if (echo > /dev/tcp/keycloak-service/8080) >/dev/null 2>&1; then
                  SOCKET_OK=true
                  break
                fi
                echo "Socket not ready yet..."
                sleep 5
              done
              [ "$SOCKET_OK" != "true" ] && echo "ERROR: Keycloak service unreachable" && exit 1

              echo "Checking Keycloak authentication..."
              LOGIN_SUCCESS=false
              for i in {1..3}; do
                if /opt/keycloak/bin/kcadm.sh config credentials \
                  --server $KC --realm master \
                  --user "$BREAKGLASS_USER" --password "$BREAKGLASS_PASSWORD"; then
                  LOGIN_SUCCESS=true
                  break
                fi
                echo "Login not ready yet..."
                sleep 5
              done
              [ "$LOGIN_SUCCESS" != "true" ] && echo "ERROR: Cannot login to Keycloak" && exit 1

              BG_ID=$(/opt/keycloak/bin/kcadm.sh get users -r master -q username="$BREAKGLASS_USER" --fields id --format csv | tail -n1)
              ROLE_CHECK=$(/opt/keycloak/bin/kcadm.sh get users/$BG_ID/role-mappings/realm -r master | grep '"name" : "admin"' || true)
              [ -z "$ROLE_CHECK" ] && echo "Breakglass not admin — abort" && exit 1

              if ! /opt/keycloak/bin/kcadm.sh get identity-provider/instances/azure -r master >/dev/null 2>&1; then
                echo "IdP missing — abort"
                exit 1
              fi

              OLD_ID=$(/opt/keycloak/bin/kcadm.sh get users -r master -q username="$BOOTSTRAP_USER" --fields id --format csv | tail -n1)
              [ -z "$OLD_ID" ] && exit 0

              /opt/keycloak/bin/kcadm.sh delete users/$OLD_ID -r master
          env:
            - name: BOOTSTRAP_USER
              value: admin
            - name: BREAKGLASS_USER
              valueFrom:
                secretKeyRef:
                  name: keycloak-breakglass
                  key: username
            - name: BREAKGLASS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-breakglass
                  key: password

---
