vault:
  server:
    standalone:
      enabled: true

    postStart:
      - /bin/sh
      - -c
      - |
        set -euo pipefail
        export VAULT_ADDR=http://127.0.0.1:8200

        echo "=== Vault bootstrap starting ==="

        INIT_FILE=/vault/data/init.txt

        ########################################
        # 1. Initialize (only once)
        ########################################

        if [ ! -f "$INIT_FILE" ]; then
          echo "Initializing Vault..."

          until vault operator init -key-shares=1 -key-threshold=1 > "$INIT_FILE" 2>/dev/null; do
            sleep 2
          done

          echo "Vault initialized"
        else
          echo "Vault already initialized"
        fi

        ########################################
        # 2. Read keys
        ########################################

        UNSEAL_KEY=$(grep "Unseal Key 1:" "$INIT_FILE" | awk '{print $4}')
        ROOT_TOKEN=$(grep "Initial Root Token:" "$INIT_FILE" | awk '{print $4}')

        ########################################
        # 3. Unseal
        ########################################

        echo "Unsealing Vault..."

        until vault operator unseal "$UNSEAL_KEY" >/dev/null 2>&1; do
          sleep 2
        done

        echo "Vault unsealed"

        ########################################
        # 4. Authenticated configuration
        ########################################

        export VAULT_TOKEN="$ROOT_TOKEN"

        echo "Configuring Kubernetes auth..."

        vault auth enable kubernetes 2>/dev/null || true

        vault write auth/kubernetes/config \
          token_reviewer_jwt="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
          kubernetes_host="https://${KUBERNETES_PORT_443_TCP_ADDR}:443" \
          kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
          issuer="https://kubernetes.default.svc.cluster.local"

        echo "Writing ESO policy..."

        vault policy write eso-policy - <<EOF
        path "local/metadata/*" {
          capabilities = ["read", "list", "create", "update"]
        }

        path "local/data/*" {
          capabilities = ["read", "create", "update"]
        }
        EOF

        vault policy write keycloak-bootstrap - <<'EOF'
        path "local/data/management/keycloak/bootstrap" {
          capabilities = ["read", "update", "patch"]
        }

        path "local/data/management/keycloak/administrator" {
          capabilities = ["read"]
        }

        path "local/data/management/pki" {
          capabilities = ["read", "update", "patch"]
        }

        # KV v2: metadata path
        path "local/metadata/management/keycloak/*" {
          capabilities = ["read", "list"]
        }

        path "local/metadata/management/pki" {
          capabilities = ["read", "list"]
        }
        EOF

        echo "Creating ESO role..."

        vault write auth/kubernetes/role/external-secrets \
          bound_service_account_names=external-secrets \
          bound_service_account_namespaces=platform-resources \
          policies=eso-policy \
          ttl=1h \
          audience="https://kubernetes.default.svc.cluster.local"

        vault write auth/kubernetes/role/keycloak-bootstrap \
          bound_service_account_names="keycloak-bootstrap" \
          bound_service_account_namespaces="keycloak" \
          policies="keycloak-bootstrap" \
          ttl="1h" \
          audience="https://kubernetes.default.svc.cluster.local"

        ########################################
        # 5. Enable secrets engines
        ########################################

        echo "Ensuring KV engines exist..."

        vault secrets list | grep -q '^local/' || \
          vault secrets enable -path=local kv-v2

        echo "=== Vault bootstrap complete ==="
